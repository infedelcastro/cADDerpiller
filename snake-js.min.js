function SnakeJS(parentElement,config){function Engine(parentElement){var snake,view,inputInterface,grid,currentState,frameIntervalId,score,bonusTimer,highScore,count,target,collisionFramesLeft,candy=[];this.initGame=function(){switch(view=new View(parentElement,config.backgroundColor),inputInterface=new InputInterface(this.pauseGame,this.resumeGame,startMoving),snake=new Snake,grid=new Grid(config.gridWidth,config.gridHeight),score=0,highScore=score,snake.points.push(randomPoint(grid)),snake.growthLeft=constants.INITIAL_SNAKE_GROWTH_LEFT,config.difficulty){case 1:case 3:target=10;break;case 2:target=20}engine.initRound(),view.initPlayField(),drawCurrentScene(),inputInterface.startListening(),view.playBgAudio(),currentState=constants.STATE_READY},this.initRound=function(){count=0,generateCandy(),bonusTimer=new Date},this.pauseGame=function(){currentState===constants.STATE_PLAYING&&(clearInterval(frameIntervalId),currentState=constants.STATE_PAUSED)},this.resumeGame=function(){currentState===constants.STATE_PAUSED&&(frameIntervalId=setInterval(nextFrame,config.frameInterval),currentState=constants.STATE_PLAYING)},this.getHighScore=function(){return highScore};var gameOver=function(){currentState=constants.STATE_GAME_OVER,clearInterval(frameIntervalId);var a=function(){snake.points.length>1?(snake.points.pop(),drawCurrentScene(),setTimeout(a,config.frameInterval/4)):setTimeout(b,10*config.frameInterval)},b=function(){score=0,snake.growthLeft=constants.INITIAL_SNAKE_GROWTH_LEFT,snake.alive=!0,count=0,generateCandy(),drawCurrentScene(),currentState=constants.STATE_READY};setTimeout(a,10*config.frameInterval)},startMoving=function(){currentState===constants.STATE_READY&&(frameIntervalId=setInterval(nextFrame,config.frameInterval),currentState=constants.STATE_PLAYING)},nextFrame=function(){function b(){for(var a=candy.length;a--;)candy.splice(a,1)}var a=!1;return moveSnake(inputInterface.lastDirection())?(collisionFramesLeft=config.collisionTolerance,candy.forEach(function(b,c){b.point.collidesWith(snake.points[0])&&(eatCandy(b),candy.splice(c,1),count==target?(score+=10,score+=bonusPoints(),a=!0,view.playWinAudio(),view.setCaterStatus(2),setTimeout(function(){view.setCaterStatus(0),engine.initRound()},1e3)):count>target&&(score>4&&(score-=5),a=!0,view.playFailAudio(),view.setCaterStatus(1),setTimeout(function(){view.setCaterStatus(0),engine.initRound()},1e3)))}),highScore=Math.max(score,highScore),drawCurrentScene(),void(a&&b())):collisionFramesLeft>0?void collisionFramesLeft--:(snake.alive=!1,drawCurrentScene(),view.playFailAudio(),void gameOver())},bonusPoints=function(){var a=new Date,b=-1*(bonusTimer-a);return b<1e4?3:b<2e4?2:b<3e4?1:0},drawCurrentScene=function(){view.clear(),view.drawSnake(snake,config.snakeColor),candy.forEach(function(a){view.drawCandy(a)}),view.drawScore(score,highScore,target,count)},moveSnake=function(a){var b=snake.points[0],c=actualDirection(a||constants.DEFAULT_DIRECTION),d=movePoint(b,c);return insideGrid(d,grid)||shiftPointIntoGrid(d,grid),snake.collidesWith(d,!0)?!1:(snake.direction!=c&&view.playDirectionAudio(),snake.direction=c,snake.points.unshift(d),snake.growthLeft>=1?snake.growthLeft--:snake.points.pop(),!0)},eatCandy=function(a){count+=a.score,snake.growthLeft+=a.calories,view.playEatAudio()},randomCandy=function(a){do var b=randomPoint(grid);while(snake.collidesWith(b));return new Candy(b,a)},generateCandy=function(){var a=2,b=generateCandyPair(),c=generateCandyPair();3==config.difficulty&&(a=3),b.forEach(function(a,b){candy[b]=randomCandy(a)}),c.forEach(function(b,c){candy[c+a]=randomCandy(b)})},generateCandyPair=function(){var a;if(config.difficulty<3){var b;do b=Math.ceil(Math.random()*target);while(b>=target||b<=0);a=[b,target-b]}else{var c,d,e;do{do c=Math.ceil(Math.random()*target),d=target-c;while(c>=target||c<=0);if(c>=d){var f=c;do e=Math.ceil(Math.random()*f),c=f-e;while(e>=f||e<=0)}else{var f=d;do e=Math.ceil(Math.random()*f),d=f-e;while(e>=f||e<=0)}a=[c,d,e]}while(c+d+e!=target)}return a},actualDirection=function(a){return 1===snake.points.length?a:utilities.oppositeDirections(snake.direction,a)?snake.direction:a},movePoint=function(oldPoint,direction){var newPoint;with(constants)switch(direction){case DIRECTION_LEFT:newPoint=new Point(oldPoint.left-1,oldPoint.top);break;case DIRECTION_UP:newPoint=new Point(oldPoint.left,oldPoint.top-1);break;case DIRECTION_RIGHT:newPoint=new Point(oldPoint.left+1,oldPoint.top);break;case DIRECTION_DOWN:newPoint=new Point(oldPoint.left,oldPoint.top+1)}return newPoint},shiftPointIntoGrid=function(a,b){return a.left=shiftIntoRange(a.left,b.width),a.top=shiftIntoRange(a.top,b.height),a},shiftIntoRange=function(a,b){var c,d;return 1==utilities.sign(a)?(d=Math.floor(a/b),c=a-b*d):-1==utilities.sign(a)?(d=Math.floor(Math.abs(a)/b)+1,c=a+b*d):c=a,c},insideGrid=function(a,b){return a.left<0||a.top<0||a.left>=b.width||a.top>=b.height?!1:!0},randomPoint=function(a){var b=utilities.randomInteger(0,a.width-1),c=utilities.randomInteger(0,a.height-1),d=new Point(b,c);return d}}function Grid(a,b){this.width=a,this.height=b}function Snake(){this.direction=constants.DEFAULT_DIRECTION,this.points=[],this.growthLeft=0,this.alive=!0,this.collidesWith=function(a,b){range=b&&0===this.growthLeft?this.points.length-1:this.points.length;for(var c=0;c<range;c++)if(a.collidesWith(this.points[c]))return!0;return!1}}function Point(a,b){this.left=a,this.top=b,this.collidesWith=function(a){return a.left==this.left&&a.top==this.top?!0:!1}}function Candy(a,b){this.point=a,this.score,this.calories,this.radius,this.color,this.decrement,this.minRadius,this.score=b,this.calories=1,this.radius=.45,this.color=config.candyColor,this.age=function(){return this.type===constants.CANDY_SHRINKING?(this.radius-=this.decrement,this.radius<this.minRadius?!1:!0):!0}}function Utilities(){this.sign=function(a){return a>0?1:a<0?-1:0===a?0:void 0},this.oppositeDirections=function(a,b){return Math.abs(a)==Math.abs(b)&&-1==this.sign(a*b)?!0:!1},this.mergeObjects=function(a,b){var c={};for(key in a)c[key]="undefined"===typeof b[key]?a[key]:b[key];return c},this.randomInteger=function(a,b){var c=a+Math.floor(Math.random()*(b+1));return c}}function View(a,b){var c,d,e,f,g,h,i,j,k,p,q,l=new Array,m=225,n=150,o=0;d=document.getElementById("candyImg"),e=document.getElementById("branchImg"),f=document.getElementById("goalImg"),l[0]=document.getElementById("caterNeutral"),l[1]=document.getElementById("caterSad"),l[2]=document.getElementById("caterHappy"),k=document.getElementById("moveDirectionAudio"),h=document.getElementById("winAudio"),g=document.getElementById("failAudio"),i=document.getElementById("eatAudio"),j=document.getElementById("bgAudio"),j.loop=!0,this.initPlayField=function(){q=s(.9),c=document.createElement("canvas"),c.setAttribute("id","snake-js"),c.setAttribute("width",config.gridWidth*config.pointSize),c.setAttribute("height",config.gridHeight*config.pointSize+constants.SCOREBOARD_HEIGHT),a.appendChild(c),p=c.getContext("2d"),p.translate(0,constants.SCOREBOARD_HEIGHT)},this.drawSnake=function(a,b){if(1===a.points.length){var c=t(a.points[0]);p.fillStyle=b,p.beginPath(),p.arc(c.left,c.top,q/2,0,2*Math.PI,!1),p.fill()}else for(var d=0;d<a.points.length;d++){var e=a.points[d],f=t(e);p.fillStyle=(d+1)%2==1?"#ED2024":"#F7941D",p.strokeStyle="#000",p.beginPath(),p.arc(f.left,f.top,q/2,0,2*Math.PI,!1),p.fill(),p.stroke()}r(a,a.direction)},this.drawCandy=function(a){p.fillStyle=a.color;var b=t(a.point);1==d.complete&&p.drawImage(d,b.left-config.pointSize/2,b.top-config.pointSize/2,config.pointSize,config.pointSize),p.fillStyle=config.scoreTextColor,p.textAlign="center",p.font="bold 16px 'Courier new', monospace",p.fillText(a.score,b.left,b.top+config.pointSize/4)},this.clear=function(a){p.fillStyle=a||b,p.fillRect(0,0,config.gridWidth*config.pointSize,config.gridHeight*config.pointSize);for(var c=0;c<config.gridWidth;c++)p.strokeStyle=config.gridColor,p.lineWidth=2,p.moveTo(c*config.pointSize,0),p.lineTo(c*config.pointSize,config.gridHeight*config.pointSize),p.stroke();for(var d=0;d<config.gridHeight;d++)p.strokeStyle=config.gridColor,p.lineWidth=2,p.moveTo(0,d*config.pointSize),p.lineTo(config.gridWidth*config.pointSize,d*config.pointSize),p.stroke()},this.getCaterStatus=function(){return o},this.setCaterStatus=function(a){o=a},this.drawScore=function(a,b,c,d){p.translate(0,-1*constants.SCOREBOARD_HEIGHT);var g=20,h=10,i=15,j=5,k=0,q=(config.gridWidth*config.pointSize-i-k-(i+k))/c;if(p.fillStyle=config.scoreBoardColor,p.fillRect(0,0,config.gridWidth*config.pointSize,constants.SCOREBOARD_HEIGHT),1==e.complete&&p.drawImage(e,0,constants.SCOREBOARD_HEIGHT-constants.BRANCH_HEIGHT,config.pointSize*config.gridWidth,constants.BRANCH_HEIGHT),(o>2||o<0)&&(o=0),p.drawImage(l[o],config.gridWidth*config.pointSize/2-m/2,-20,m,n),1==f.complete){var r=i+k+q*d,s=constants.SCOREBOARD_HEIGHT-constants.BRANCH_HEIGHT;p.drawImage(f,r-10,s-constants.GOAL_HEIGHT/2,constants.GOAL_WIDTH,constants.GOAL_HEIGHT)}p.fillStyle=config.scoreTextColor,p.font="bold 24px 'Courier new', monospace",p.strokeStyle=config.numberLineColor,p.beginPath(),p.moveTo(i+k,constants.SCOREBOARD_HEIGHT-constants.BRANCH_HEIGHT/2),p.lineTo(config.gridWidth*config.pointSize-i-k,constants.SCOREBOARD_HEIGHT-constants.BRANCH_HEIGHT/2),p.stroke(),p.textAlign="center";for(var t=0;t<=c;t++){var r=i+k+q*t;p.fillStyle=config.numberLineColor,p.beginPath(),p.moveTo(r,constants.SCOREBOARD_HEIGHT-constants.BRANCH_HEIGHT/2-j),p.lineTo(r,constants.SCOREBOARD_HEIGHT-constants.BRANCH_HEIGHT/2+j),p.stroke(),p.fillText(t,r,constants.SCOREBOARD_HEIGHT-h)}p.textAlign="right",p.fillText(a,config.gridWidth*config.pointSize-i,g),p.textAlign="left",p.fillText(b,i,g),p.translate(0,constants.SCOREBOARD_HEIGHT)};var r=function(a){var b=a.points[0],c=t(b),d=s(.125),e=s(.15);switch(a.direction){case constants.DIRECTION_LEFT:c.left-=d,c.top-=e;break;case constants.DIRECTION_RIGHT:c.left+=d,c.top-=e;break;case constants.DIRECTION_UP:c.left-=e,c.top-=d;break;case constants.DIRECTION_DOWN:c.left+=e,c.top+=d}a.alive?(p.beginPath(),p.fillStyle=config.snakeEyeColor,p.arc(c.left,c.top,s(.125),0,2*Math.PI,!1),p.fill()):(p.beginPath(),p.strokeStyle=config.snakeEyeColor,p.lineWidth=2,p.moveTo(c.left-s(.1),c.top-s(.1)),p.lineTo(c.left+s(.1),c.top+s(.1)),p.moveTo(c.left+s(.1),c.top-s(.1)),p.lineTo(c.left-s(.1),c.top+s(.1)),p.stroke())},s=function(a){return a*config.pointSize},t=function(a){var b={left:a.left*s(1)+s(.5),top:a.top*s(1)+s(.5)};return b};this.playDirectionAudio=function(){k.play()},this.playWinAudio=function(){h.play()},this.playFailAudio=function(){g.play()},this.playEatAudio=function(){i.play()},this.playBgAudio=function(){j.play()}}function InputInterface(pauseFn,resumeFn,autoPlayFn){var arrowKeys=[37,38,39,40],listening=!1,lastDirection=null;this.lastDirection=function(){return lastDirection},this.startListening=function(){listening||(window.addEventListener("keydown",handleKeyDown,!0),window.addEventListener("keypress",disableKeyPress,!0),window.addEventListener("blur",pauseFn,!0),window.addEventListener("focus",resumeFn,!0),listening=!0)},this.stopListening=function(){listening&&(window.removeEventListener("keydown",handleKeyDown,!0),window.removeEventListener("keypress",disableKeyPress,!0),window.removeEventListener("blur",pauseFn,!0),window.removeEventListener("focus",resumeFn,!0),listening=!1)};var handleKeyDown=function(a){arrowKeys.indexOf(a.keyCode)>=0&&handleArrowKeyPress(a)},disableKeyPress=function(a){arrowKeys.indexOf(a.keyCode)>=0&&a.preventDefault()},handleArrowKeyPress=function(event){with(constants)switch(event.keyCode){case 37:lastDirection=DIRECTION_LEFT;break;case 38:lastDirection=DIRECTION_UP;break;case 39:lastDirection=DIRECTION_RIGHT;break;case 40:lastDirection=DIRECTION_DOWN}event.preventDefault(),autoPlayFn()}}var utilities=new Utilities,defaultConfig={autoInit:!0,gridWidth:30,gridHeight:20,frameInterval:150,pointSize:24,backgroundColor:"#E0B687",snakeColor:"#CF2900",snakeEyeColor:"white",candyColor:"#b11c1c",shrinkingCandyColor:"#199C2C",scoreBoardColor:"#c0c96b",scoreTextColor:"#4b4312",gridColor:"#754C24",numberLineColor:"#ffffff",collisionTolerance:1,difficulty:3},config=config?utilities.mergeObjects(defaultConfig,config):defaultConfig,constants={DIRECTION_UP:1,DIRECTION_RIGHT:2,DIRECTION_DOWN:-1,DIRECTION_LEFT:-2,DEFAULT_DIRECTION:2,STATE_READY:1,STATE_PAUSED:2,STATE_PLAYING:3,STATE_GAME_OVER:4,INITIAL_SNAKE_GROWTH_LEFT:1,SCOREBOARD_HEIGHT:150,BRANCH_HEIGHT:75,GOAL_WIDTH:75,GOAL_HEIGHT:75,CANDY_REGULAR:1,CANDY_MASSIVE:2,CANDY_SHRINKING:3,CANDY_AMOUNT:4},engine=new Engine(parentElement);this.init=function(){engine.initGame()},this.pause=function(){engine.pauseGame()},this.resume=function(){engine.resume()},this.getHighScore=function(){return engine.getHighScore()},config.autoInit&&this.init()}